#!/bin/bash

# submit with:
#       sbatch submit-array-to-graham_def-richard0.sh   

#SBATCH --mem-per-cpu=7G                          # memory; default unit is megabytes
#SBATCH --output=/dev/null
#SBATCH --time=1-00:00:00
#SBATCH --account=def-richard0
#SBATCH --mail-user=juliane.mai@uwaterloo.ca
#SBATCH --mail-type=FAIL
#SBATCH --job-name=sa-canopex
#SBATCH --array=1-134

# job-id  :: ${SLURM_ARRAY_JOB_ID}
# task-id :: ${SLURM_ARRAY_TASK_ID}

nsets=1000

# change to right dir
cd /home/julemai/projects/rpp-hwheater/julemai/xSSA-North-America/scripts

# set Python env
source ../env-3.5/bin/activate

# folders=$(  \ls -d ../data_in/data_obs/*/ | cut -d '/' -f 4 | sort )
# folders=$( cat basins_5yr_nse-gt-05.dat )                             # <<<<<<<<<<<< only basins with more than 5 years (calibrated) and NSE > 0.5

# set tasks to 139
# basins=(06024540 06025250 06025500 06026500 06033000 06036650 06036905 06037500 06038800 06040800 06041000 06043500 06048700 06052500 06054500 06065500 06066500 06071300 06073500 06076690 06077200 06078200 06085800 06088500 06089000 06090800 06091700 06099000 06101500 06102050 06108000 06108800 06109500 06114700 06119600 06120500 06123030 06126050 06126500 06127500 06130500 06166000 06186500 06188000 06191000 06191500 06192500 06195600 06200000 06205000 06207500 06208500 06212500 06214500 06216900 06218500 06220500 06220800 06225500 06227600 06228000 06235500 06236100 06259000 06274300 06276500 06279500 06279940 06280300 06281000 06282000 06287000 06290500 06294000 06295000 06298000 06299980 06305700 06306250 06306300 06307500 06307616 06307830 06307990 06308400 06308500 06309000 06313500 06313590 06316400 06317000 06324000 06324500 06324970 06326500 06327500 06329500 06331000 06334500 06335500 06336000 06337000 06339500 06340000 06340500 06345780 06347000 06347500 06348300 06349000 06350000 06351200 06352000 06353000 06354000 06354815 06354882 06355500 06357800 06359500 06360500 06386500 06395000 06406500 06408500 06410500 06411500 06412200 06412500 06414000 06418900 06421500 06423500 06425100 06425500 06426500 06428200 06430500 06432020)

# set tasks to 139
# basins=(06433000 06436000 06436760 06437000 06438000 06438500 06439000 06440200 06441500 06442900 06445685 06445700 06446000 06447000 06447230 06447450 06449100 06449500 06450500 06452000 06452320 06453255 06453600 06463500 06464100 06464500 06465000 06465500 06468170 06468250 06469400 06470000 06470500 06470878 06471000 06471200 06471500 06472000 06473000 06475000 06476000 06477000 06477500 06478500 06478513 06478600 06478690 06479010 06481500 06482020 06482610 06483290 06483500 06485500 06600100 06600500 06601200 06602400 06605000 06605850 06606600 06607200 06607500 06608500 06609500 06610000 06620000 06625000 06630000 06634620 06635000 06639000 06652000 06653300 06653500 06659500 06659502 06661585 06664400 06696000 06699005 06701500 06701900 06707500 06709000 06709530 06710245 06710247 06711500 06711565 06713000 06713300 06714000 06714215 06718300 06719505 06720500 06721000 06724000 06725450 06730200 06730500 06731000 06738000 06741510 06751150 06751490 06752000 06752260 06752280 06752500 06754000 06756100 06758500 06759500 06759910 06764880 06786000 06787000 06797500 06799000 06799100 06799350 06799500 06800500 06803080 06803486 06803500 06803513 06803555 06804700 06806500 06807410 06808500 06809210 06809500 06810000 06811500 06813500)

# set tasks to 139
# basins=(06814000 06814500 06815000 06817000 06817700 06820500 06821190 06853800 06854000 06863500 06865500 06866500 06866900 06867000 06868200 06869500 06869950 06870200 06873000 06873460 06874000 06875900 06876070 06876700 06876900 06877600 06878000 06879100 06881000 06882000 06882510 06883000 06884000 06884025 06884200 06884400 06885500 06887000 06887500 06888000 06888350 06888500 06889000 06890100 06891000 06892000 06892350 06893578 06897500 06898000 06899500 06900050 06901500 06902000 06904010 06904050 06904500 06905500 06906000 06906300 06906800 06908000 06910750 06911400 06913000 06913500 06914000 06914100 06915800 06916600 06917000 06917060 06917380 06917560 06917680 06918060 06918065 06918070 06918440 06918460 06918740 06919020 06919500 06919900 06921070 06921350 06921760 06922450 06923250 06923950 06926000 06926500 06926510 06927000 06928000 06928430 06930000 06930060 06932000 06933500 06934000 06AC001 06AD001 06AF005 06AG001 06AG002 06BA002 06BB003 06BB005 06BD001 06CD002 06DA002 06DA004 06DC001 06FA001 06FB002 06FC001 06FD002 06GA001 07013000 07014500 07016500 07018100 07018500 07019000 07021000 07024500 07025400 07026040 07027720 07028960 07029500 07030050 07030240 07030392 07030500 07031650 07031740 07034000)

# set tasks to 139
# basins=(07035800 07036100 07037500 07039500 07040100 07040450 07047942 07047950 07048600 07049000 07050500 07050700 07052250 07052345 07052500 07053500 07054080 07055608 07056000 07056700 07057370 07057500 07058000 07061000 07061500 07062500 07063000 07064000 07064533 07065495 07066000 07067000 07068000 07069000 07069305 07069500 07071500 07072000 07072500 07074000 07074420 07074500 07074850 07076620 07077380 07083710 07086000 07087050 07091200 07093700 07093775 07094500 07096000 07096250 07096500 07097000 07099400 07099970 07104000 07105500 07105530 07105800 07106000 07106300 07106500 07108900 07109500 07119700 07123000 07124000 07124200 07134100 07138070 07139500 07140000 07142620 07143300 07143665 07143672 07144100 07144200 07144780 07144795 07145200 07145500 07146830 07147070 07147800 07148400 07149000 07151000 07151500 07152000 07153000 07155590 07159750 07160500 07165750 07166000 07166500 07169500 07169800 07170500 07170990 07171000 07171600 07172000 07174400 07175500 07176000 07176500 07177500 07178000 07178200 07179500 07179730 07180200 07180400 07182250 07182510 07183000 07183500 07184000 07185000 07185765 07186000 07187000 07188000 07188838 07188885 07189000 07190500 07191000 07191288 07191500 07195400 07195430 07195500 07196500)

# set tasks to 139
# basins=(07197000 07198000 07211000 07211500 07216500 07221000 07221500 07230500 07231000 07237500 07242380 07243500 07247000 07247015 07249413 07251500 07257006 07257500 07258500 07260500 07260673 07261500 07263012 07264000 07268000 07274000 07281600 07283000 07285400 07288280 07288500 07288650 07288955 07289730 07290000 07290650 07292500 07299670 07301420 07301500 07303400 07305000 07307028 07311000 07311500 07311700 07311900 07312200 07312700 07314500 07315500 07315700 07324200 07324400 07325000 07325500 07326500 07327550 07328100 07328500 07331000 07332500 07334000 07335000 07335300 07335790 07336200 07337900 07338500 07338750 07340000 07341200 07342500 07343200 07343500 07344493 07346000 07346045 07346050 07346070 07348700 07351750 07356000 07359002 07362000 07362100 07362500 07363000 07363200 07363400 07363500 07364100 07369680 07371500 07372050 07372200 07375500 07376000 07377000 07378000 07378500 07380120 07382000 07382500 07383500 07AA004 07AC007 07AE001 07AF013 07AF015 07AG003 07AG004 07AH002 07BB005 07BC006 07BF009 07BK001 07CD004 07DA001 07DA008 07EA002 07EA004 07EA005 07EA007 07EB002 07EC002 07EC003 07EC004 07ED001 07ED003 07EE007 07EE009 07EE010 07FA005 07FA006 07FB001 07FB002 07FB003 07FB006)

# set tasks to 134
basins=(07FB008 07FB009 07FC001 07FC003 07FD001 07FD006 07FD007 07FD011 07GC002 07GD001 07GD002 07GE001 07GG001 07GG003 07GH002 07GJ001 07JA003 07JD002 07JF002 07LB002 07MA003 07MB001 08012000 08012150 08013000 08013500 08014500 08015500 08017410 08018500 08019000 08019200 08019500 08020000 08020900 08022040 08026000 08028000 08028500 08032000 08033500 08034500 08036500 08040600 08041000 08041500 08041700 08041749 08041780 08043950 08044000 08049500 08050100 08051500 08053000 08053500 08055500 08057000 08057410 08061750 08062000 08062500 08062700 08064100 08065000 08065350 08065800 08066250 08066500 08067650 08068000 08068090 08068500 08068800 08069000 08070000 08070200 08071280 08073600 08073700 08084000 08084800 08085500 08086050 08086212 08086290 08091500 08092000 08093360 08093500 08098290 08099300 08103800 08104100 08104700 08106500 08109800 08110800 08111700 08130700 08143600 08144600 08148500 08150000 08150700 08152000 08153500 08164000 08164300 08164390 08164450 08167000 08167500 08171000 08172000 08173000 08173900 08174600 08175000 08175800 08176500 08180500 08180640 08180700 08180800 08181480 08181500 08181800 08183500 08185500 08186000 08186500 08188500 08188800)

if [ ! -e ../data_out/${bb}/results_nsets${nsets}.token ] ; then

    # actual analysis
    bb=$( echo ${basins[$(( ${SLURM_ARRAY_TASK_ID} - 1 ))]} )
    python raven_sa-usgs-canopex.py -i ${bb} -n ${nsets} -t ${SLURM_TMPDIR} -o nc

    # # extract only sensitivity results from pickle file
    # pickle_all="../data_out/${bb}/results_nsets${nsets}.pkl"
    # pickle_si="../data_out/${bb}/sensitivity_nsets${nsets}.pkl"
    # python extract_si_results_from_pkl.py -i ${pickle_all} -o ${pickle_si}
    
    # plot results
    python figure_2.py -t pdf -p ../data_out/${bb}/${bb} -n ${nsets} -i ../data_out/${bb}/results_nsets${nsets}.nc -o nc
    pdfcrop ../data_out/${bb}/${bb}.pdf
    mv ../data_out/${bb}/${bb}-crop.pdf ../data_out/${bb}/${bb}.pdf
    
fi


# 1000 sets, package 1, 139 basins
# job ID: 30681678

# 1000 sets, package 2, 139 basins
# job ID: 30721124

# 1000 sets, package 3, 139 basins
# job ID: 30767458

# 1000 sets, package 4, 139 basins
# job ID: 30810138

# 1000 sets, package 5, 139 basins
# job ID: 30822781

# 1000 sets, package 6, 134 basins
# job ID: 30849894
