#!/bin/bash

# submit with:
#       sbatch submit-array-to-graham_def-jrcraig1.sh   

#SBATCH --mem-per-cpu=7G                          # memory; default unit is megabytes
#SBATCH --output=/dev/null
#SBATCH --time=1-00:00:00
#SBATCH --account=def-jrcraig1
#SBATCH --mail-user=juliane.mai@uwaterloo.ca
#SBATCH --mail-type=FAIL
#SBATCH --job-name=sa-canopex
#SBATCH --array=1-134

# job-id  :: ${SLURM_ARRAY_JOB_ID}
# task-id :: ${SLURM_ARRAY_TASK_ID}

nsets=1000

# change to right dir
cd /home/julemai/projects/rpp-hwheater/julemai/xSSA-North-America/scripts

# set Python env
source ../env-3.5/bin/activate

# folders=$(  \ls -d ../data_in/data_obs/*/ | cut -d '/' -f 4 | sort )
# folders=$( cat basins_5yr_nse-gt-05.dat )                             # <<<<<<<<<<<< only basins with more than 5 years (calibrated) and NSE > 0.5

# set tasks to 139
# basins=(03184000 03184500 03185400 03189100 03189600 03190400 03192000 03193000 03194700 03197000 03198000 03198500 03200500 03201902 03202000 03202400 03203600 03205470 03207800 03208500 03209000 03209500 03212500 03212980 03213700 03214500 03216500 03217000 03219500 03221000 03225500 03226800 03227500 03229500 03229610 03230500 03230800 03231500 03232000 03234000 03234300 03234500 03237020 03237255 03237500 03238500 03245500 03247500 03249500 03250500 03251200 03251500 03253500 03261500 03262000 03262700 03263000 03265000 03266000 03267900 03269500 03270000 03270500 03271601 03271800 03272000 03272100 03274000 03275000 03275600 03276000 03276500 03277500 03280000 03281000 03281500 03282000 03282120 03282290 03283500 03284000 03284500 03285000 03286500 03287000 03287500 03289500 03290500 03291500 03295890 03298500 03300400 03301000 03301500 03302800 03303000 03308500 03310300 03314500 03316500 03320000 03320500 03321060 03322900 03322985 03323500 03324000 03324300 03325000 03326500 03327500 03328000 03328500 03329000 03329700 03331500 03331753 03333050 03333700 03334000 03334500 03335000 03335500 03336000 03336645 03338780 03339000 03339500 03340500 03341300 03341500 03342000 03342500 03345500 03346000 03346500 03347000 03348000 03348130)

# # set tasks to 139
# basins=(03349000 03351000 03352500 03353000 03353611 03353800 03354000 03357500 03358000 03360000 03360500 03361500 03362500 03363500 03363900 03364000 03365500 03366500 03369500 03371500 03373500 03374000 03375500 03376300 03376500 03377500 03378000 03378635 03379500 03380500 03381500 03383000 03401000 03402900 03403500 03403910 03404000 03404500 03406500 03408500 03409500 03410210 03410500 03414500 03421000 03422500 03424730 03426310 03427500 03428500 03431500 034315005 03432400 03433500 03434500 03435305 03436100 03438000 03438220 03443000 03447687 03451500 03453500 03455000 03459500 03460795 03461500 03465500 03467000 03467609 03473000 03475000 03488000 03498500 03498850 03503000 03510577 03513000 0351706800 03524000 03527000 03528000 03531500 03532000 03539800 03540500 03548500 03563000 03566000 03568000 03571000 03574500 03575100 03575500 03584020 03584600 03588500 03589500 03593500 03597860 03598000 03599240 03599500 03601990 03603000 03604000 03604400 03606500 03612000 03AB002 03AC004 03BC002 03BD002 03BF001 03CB004 03ED001 03FA003 03FC007 03KC004 03MB002 03MD001 03NF001 03OC003 03PB002 03QC001 03QC002 04024000 04024430 04027000 04027500 04029990 04031000 04041500 04045500 04056500 04058100 04059000 04059500 04060993)

# # set tasks to 139
# basins=(04062000 04062011 04063000 04063500 04064500 04065106 04065722 04066003 04066030 04066500 04066800 04067500 04067958 04069416 04069500 04071000 04071765 04073365 04073500 04074950 04077400 04078500 04079000 04082400 04084445 040851385 04085427 04086000 04086600 04087000 04087170 04096405 04097500 04099750 04100500 04101000 04101500 04101800 04102500 04103010 04103500 04105000 04105500 04106000 04106906 04107850 04108660 04108670 04111000 04112500 04113000 04114000 04114498 04114500 04115000 04116000 04117500 04119000 04121300 04121500 04122200 04122500 04124000 04124200 04125460 04125550 04130500 04133501 04135700 04136000 04136500 04136900 04137005 04137500 04142000 04146063 04147500 04148500 04149000 04150500 04151500 04154000 04155000 04155500 04156000 04159492 04161820 04164000 04164500 04165500 04172000 04174500 04176000 04176500 04178000 04180000 04180500 04181500 04182000 04183000 04184500 04185000 04186500 04189000 04191500 04192500 04193500 04195500 04195820 04196500 04196800 04198000 04199000 04199500 04200500 04201500 04206000 04208000 04208504 04209000 04212100 04213500 04218000 04221000 04223000 04227000 04227500 04228500 04229500 04230500 04232000 04232482 04235440 04235500 04235600 04237500 04246500 04247000 04249000)

# # set tasks to 139
# basins=(04250200 04252500 04260500 04262000 04262500 04263000 04265432 04266500 04267500 04268000 04269000 04273500 04275500 04276500 04282000 04282500 04286000 04292000 04292500 04293500 04294000 04AA004 04AB001 04AD002 04CA002 04CA003 04CB001 04DA001 04DB001 04DC001 04DC002 04FA001 04FA003 04FC001 04GA002 04GB004 04KA001 04LM001 04MD004 04MF001 04NB001 05017500 05030500 05046000 05050000 05051300 05051522 05051600 05053000 05054000 05054500 05055300 05056000 05057200 05059700 05060000 05060100 05061000 05061500 05062000 05062500 05064000 05066500 05074500 05076000 05078000 05078230 05078500 05079000 05080000 05082500 05082625 05084000 05087500 05090000 05092000 05094000 05107500 05112000 05123400 05123510 05127000 05127500 05129115 05131500 05132000 05200510 05211000 05212700 05227500 05242300 05244000 05247500 05261000 05267000 05270500 05270700 05280000 05286000 05288500 05290000 05291000 05292000 05292704 05293000 05294000 05300000 05304500 05311000 05313500 05315000 05316500 05316580 05317000 05319500 05320000 05320500 05325000 05327000 05330000 05330920 05331000 05331580 05332500 05333500 05336700 05338500 05340500 05341500 05344500 05353800 05355200 05356500 05360500 05362000 05365500 05368000 05369000 05369500)

# # set tasks to 139
# basins=(05372995 05378500 05379500 05381000 05382000 05383075 05383950 05385000 05387440 05387500 05389000 05395000 05397500 05398000 05399500 05400760 05402000 05404000 05405000 05407000 05408000 05410490 05411850 05412020 05412400 05412500 05413500 05416900 05418400 05418500 05419000 05420680 05421000 05421740 05422000 05427085 05427570 05429500 05429700 05430175 05430500 05431486 05432500 05433000 05434500 05435500 05436500 05437050 05437500 05439500 05440000 05440700 05443500 05446500 05447500 05449500 05451210 05451500 05453100 05453520 05454500 05455100 05455500 05455700 05457700 05458000 05458300 05458500 05458900 05459500 05462000 05463000 05463500 05464000 05464220 05464500 05465500 05466500 05469000 05470000 05470500 05471000 05471200 05471500 05472500 05473400 05474000 05476000 05476750 05479000 05480500 05481000 05481300 05481650 05481950 05482000 05482300 05482500 05483450 05483600 05484000 05484500 05484650 05484900 05485500 05486490 05487470 05487980 05488110 05488500 05489000 05489500 05490500 05495000 05495500 05496000 05497000 05497150 05498000 05498150 05500000 05501000 05502300 05502500 05504800 05506350 05506500 05506800 05507800 05508805 05514500 05515500 05516500 05517000 05517500 05517530 05518000 05520500 05522500)

# # set tasks to 134
basins=(05524500 05525000 05525500 05526000 05527500 05528000 05529000 05532500 05536290 05540500 05542000 05543500 05545750 05550000 05550001 05551000 05551540 05552500 05554500 05555300 05556500 05558300 05567500 05568000 05568500 05569500 05570000 05570910 05572000 05573540 05576000 05576500 05578500 05579500 05580000 05582000 05583000 05584500 05585000 05585830 05586100 05587000 05587900 05590950 05591200 05592000 05592100 05593000 05593520 05593945 05594000 05594100 05594800 05597000 05599490 05AA008 05AA028 05AB005 05AH050 05BA001 05BG006 05BH009 05CA012 05CB002 05CC008 05CK007 05DC011 05DE007 05DF003 05DF004 05ED002 05EE009 05EF004 05EF005 05GF002 05GG010 05HD036 05JM010 05KB003 05KC001 05KF001 05KG002 05KG007 05KH007 05LC001 05LD001 05LE004 05LE006 05LE008 05LH005 05LJ005 05LJ007 05LL015 05MC001 05MD005 05ME003 05MF001 05MF008 05MG001 05MH006 05MH007 05NE003 05NF010 05OC016 05OE004 05OE006 05OE007 05OF020 05PB018 05PH003 05QA002 05QE008 05QE012 05RA001 05RB003 05RC001 05RD008 05RE001 05SA002 05TD001 05TE002 05TF002 05TG002 05TG003 05UA003 05UF004 05UG001 05UH001 05UH002 06012500 06016000 06019500 06020600 06024450)

if [ ! -e ../data_out/${bb}/results_nsets${nsets}.token ] ; then

    # actual analysis
    bb=$( echo ${basins[$(( ${SLURM_ARRAY_TASK_ID} - 1 ))]} )
    python raven_sa-usgs-canopex.py -i ${bb} -n ${nsets} -t ${SLURM_TMPDIR} -o nc

    # # extract only sensitivity results from pickle file
    # pickle_all="../data_out/${bb}/results_nsets${nsets}.pkl"
    # pickle_si="../data_out/${bb}/sensitivity_nsets${nsets}.pkl"
    # python extract_si_results_from_pkl.py -i ${pickle_all} -o ${pickle_si}
    
    # plot results
    python figure_2.py -t pdf -p ../data_out/${bb}/${bb} -n ${nsets} -i ../data_out/${bb}/results_nsets${nsets}.nc -o nc
    pdfcrop ../data_out/${bb}/${bb}.pdf
    mv ../data_out/${bb}/${bb}-crop.pdf ../data_out/${bb}/${bb}.pdf
    
fi


# 1000 sets, package 1, 139 basins
# job ID: 30682896

# 1000 sets, package 2, 139 basins
# job ID: 30721122

# 1000 sets, package 3, 139 basins
# job ID: 30767465

# 1000 sets, package 4, 139 basins
# job ID: 30810141

# 1000 sets, package 5, 139 basins
# job ID: 30849896

# 1000 sets, package 6, 134 basins
# job ID: 30901379
