#!/bin/bash

# submit with:
#       sbatch submit-array-to-graham_def-btolson.sh   

#SBATCH --mem-per-cpu=7G                          # memory; default unit is megabytes
#SBATCH --output=/dev/null
#SBATCH --time=1-00:00:00
#SBATCH --account=ctb-jrcraig1                    # def-btolson
#SBATCH --mail-user=juliane.mai@uwaterloo.ca
#SBATCH --mail-type=FAIL
#SBATCH --job-name=sa-canopex
#SBATCH --array=1-134

# job-id  :: ${SLURM_ARRAY_JOB_ID}
# task-id :: ${SLURM_ARRAY_TASK_ID}

nsets=1000

# change to right dir
cd /home/julemai/projects/rpp-hwheater/julemai/xSSA-North-America/scripts

# set Python env
source ../env-3.5/bin/activate

# folders=$(  \ls -d ../data_in/data_obs/*/ | cut -d '/' -f 4 | sort )
# folders=$( cat basins_5yr_nse-gt-05.dat )                             # <<<<<<<<<<<< only basins with more than 5 years (calibrated) and NSE > 0.5

# set tasks to 139
# basins=(01010000 01010500 01013500 01014000 01015800 01017000 01018035 01021000 01021500 01022500 01027200 01030500 01031500 01034000 01034500 01036390 01046500 01047000 01048000 01049000 01049205 01049265 01049500 01053500 01054000 01054500 01059000 01064500 01065500 01066000 01076500 01080500 01081000 01081500 01085500 01092000 01096500 01099500 01100000 01104200 01104500 01108000 01112500 01113895 01116500 01118500 01122500 011230695 01125500 01127000 01129500 01130000 01131500 01135500 01138500 01144000 01144500 01151500 01152500 01154500 01155910 01160350 01161000 01166500 01168151 01168500 01170000 01170500 01172003 01172010 01173500 01177000 01183500 01188090 01189995 01197500 01198125 01199000 01200000 01200500 01205500 01208500 01315500 01318500 01321000 01327750 01329490 01329500 01331095 01334500 01335754 01343060 01346000 01347000 01350000 01350101 01350180 01350355 01351500 01357500 01358000 01364500 01367500 01371500 01375000 01381900 01388500 01389500 01400500 01402000 01403060 01417500 01420500 01420980 01421000 01423000 01426500 01427510 01428500 01431500 01434000 01437500 01438500 01442500 01446500 01447800 01449000 01451000 01453000 01454700 01463500 01465500 01470500 01471000 01471510 01472000 01473000 01473500 01474500)

# # set tasks to 139
# basins=(01481000 01481500 01502500 01503000 01505000 01509000 01512500 01515000 01518000 01518700 01520000 01520500 01526500 01529500 01529950 01531000 01531500 01532000 01533400 01534000 01536000 01536500 01539000 01540500 01541000 01541200 01541303 01542500 01543000 01543500 01544000 01545000 01545500 01547200 01547500 01548005 01548500 01549700 01551500 01552000 01553500 01554000 01555000 01556000 01558000 01559000 01562000 01563200 01563500 01566000 01567000 01568000 01570000 01570500 01571500 01573000 01573560 01573825 01574000 01575500 01576000 01576500 01576754 01578310 01589000 01594440 01595500 01595800 01598500 01600000 01601500 01603000 01604500 01606000 01606500 01608000 01608500 01610000 01611500 01613000 01614000 01614500 01616500 01618000 01619500 01622000 01625000 01627500 01628500 01629500 01631000 01632000 01633000 01634000 01636500 01638500 01642190 01643000 01644000 01646500 01646502 01663500 01664000 01667500 01668000 01670400 01671020 01671025 01672500 01673000 01674000 01674500 01AF007 01AJ010 01AL002 01AM001 01AN002 01AP002 01AP004 01BC001 01BD002 01BD008 01BE001 01BF001 01BG005 01BG009 01BH005 01BH007 01BH010 01BJ003 01BJ007 01BL003 01BP001 01BQ001 01BU002 01EC001 01ED005 01EF001 01EG002)

# # set tasks to 139
# basins=(01EN002 01EO001 01FB001 01FB003 02011800 02013100 02016000 02016500 02018000 02019500 02021500 02024000 02024752 02025500 02026000 02029000 02030500 02032515 02034000 02035000 02037500 02039500 02040000 02041650 02042500 02044500 02045500 02047000 02047500 02049500 02051500 02052000 02053200 02054500 02054510 02054530 02055000 02056000 02058400 02060500 02061500 02062500 02066000 02070500 02071000 02073000 02075045 02075500 02077000 02077303 02077500 02081747 02082506 02082585 02083000 02083500 02084000 02087183 02087500 02088500 02089000 02089500 02091814 02096500 02096960 02100500 02102000 02102500 02103000 02105500 02105769 02106500 02109500 02110500 02112000 02112250 02113850 02115360 02116500 02118000 0212433550 02124742 02126000 02129000 02130561 02130980 02131000 02131500 02133624 02134170 02134480 02134500 02135000 02135200 02136000 02140991 02145000 02146000 02147020 02147500 02148000 02148315 02151000 02151500 02153200 02153551 02155500 021556525 02156500 02160105 02160390 02160700 02161000 02162500 02163001 02163500 02165000 02166501 02167000 02167450 02169500 02173000 02173030 02173051 02173500 02174000 02175000 02175500 02177000 02191300 02192500 02193500 02196000 02196484 02197315 02197320 02197500 02197830 02198000)

# # set tasks to 139
# basins=(02202500 02202600 02203000 02207220 02207335 02210500 02213000 02215500 02217475 02217500 02217770 02218300 02220900 02223000 02223056 02223248 02223500 02225000 02225500 02226000 02226100 02226500 02227500 02228000 02231000 02231600 02232000 02232400 02232500 02233484 02233500 02234000 02234500 02236000 02236125 02240000 02240500 02243000 02245050 02246025 02256500 02268903 02270500 02294650 02294655 02294775 02294898 02296500 02297310 02298123 02298202 02298830 02301500 02301719 02303000 02303330 02304500 02310947 02311500 02312000 02312300 02312500 02312600 02312700 02312720 02312762 02313000 02313230 02314500 02315500 02315550 02316000 02317500 02317620 023177483 02318000 02318500 02318700 02319000 02319394 02319500 02319800 02320000 02320500 02321500 02321975 02322500 02322800 02323000 02323500 02323592 02326000 02326512 02326900 02327500 02328522 02329600 02330000 02330150 02331600 02336000 02336490 02337000 02337040 02337170 02338000 02338500 02339500 02341500 02341505 02341800 02342500 02344500 02347500 02349500 02349605 02350512 02350600 02350900 02351890 02352500 02353000 02353265 02353500 02354500 02354800 02355350 02355662 02357000 02358000 02358700 02358754 02358789 02359000 02359170 02361000 02361500 02363000 02364500)

# # set tasks to 139
# basins=(02365200 02365500 02366000 02366500 02367900 02369000 02369600 02370000 02370500 02371500 02372250 02372422 02373000 02374250 02374700 02375500 02376033 02376500 02380500 02382500 02383500 02384500 02387000 02387500 02388350 02388500 02395000 02395980 02396000 02397000 02398300 02399200 02400100 02404400 02408540 02411000 02411930 02412000 02413300 02414500 02414715 02418500 02419000 02419890 02420000 02421000 02422500 02423425 02423496 02423500 02423555 02424000 02425000 02427250 02428400 02435020 02436500 02437100 02438000 02439400 02440500 02441390 02442500 02443500 02444160 02446500 02447025 02448000 02450000 02450180 02455000 02455500 02455900 02456500 02462500 02462951 02464000 02465000 02467000 02467500 02469761 02472000 02472500 02472850 02473000 02473500 02474500 02474560 02474600 02475000 02475500 02476600 02477000 02477990 02478500 02479000 02479130 02479160 02479300 02479310 02479560 02481510 02481880 02482000 02482550 02483000 02483500 02484000 02486000 02487500 02488000 02488500 02489000 02489500 02490500 02492000 02AB021 02EA005 02EC018 02ED101 02FC016 02FE009 02FE013 02GA038 02GB007 02GC002 02GC010 02GD004 02JB013 02KF016 02KJ007 02LB008 02LD005 02LG005 02LH004 02MC001 02NE011 02NF003 02OB037)

# # set tasks to 134
basins=(02OD003 02OE032 02OG026 02OJ024 02PA007 02PB006 02PC009 02PD002 02PE009 02PG022 02PJ007 02PJ030 02PK005 02PL005 02PL007 02QA002 02QA017 02QB011 02QC009 02RC011 02RD002 02RD003 02RF001 02RF002 02RG005 02RH035 02RH045 02RH047 02RH049 02UC002 02VB004 02VC001 02WB003 02XA003 02YA001 02YC001 02YG001 02YJ001 02YK002 02YK005 02YL001 02YL008 02YM001 02YN002 02YO008 02YQ001 02YR003 02YS005 02ZF001 02ZH001 03007800 03010500 03011020 03014500 03015000 03015310 03015500 03016000 03020500 03023100 03024000 03025500 03029500 03030500 03031500 03032500 03036500 03040000 03041029 03041500 03048500 03049500 03050500 03051000 03053500 03054500 03057000 03058975 03061000 03065000 03069500 03070000 03070500 03072000 03072655 03075070 03076500 03079000 03081000 03082500 03083500 03085000 03085500 03086000 03091500 03094000 03097550 03098600 03102850 03105500 03106000 03106500 03107500 03109500 03112000 03114500 03115400 03117000 03117500 03124500 03129000 03136500 03139000 03140500 03142000 03146500 03150000 03150300 03152000 03155000 03157500 03159500 03161000 03164000 03165500 03167000 03168000 03170000 03171000 03173000 03175500 03176500 03179000 03183500)

if [ ! -e ../data_out/${bb}/results_nsets${nsets}.token ] ; then

    # actual analysis
    bb=$( echo ${basins[$(( ${SLURM_ARRAY_TASK_ID} - 1 ))]} )
    python raven_sa-usgs-canopex.py -i ${bb} -n ${nsets} -t ${SLURM_TMPDIR} -o nc

    # # extract only sensitivity results from pickle file
    # pickle_all="../data_out/${bb}/results_nsets${nsets}.pkl"
    # pickle_si="../data_out/${bb}/sensitivity_nsets${nsets}.pkl"
    # python extract_si_results_from_pkl.py -i ${pickle_all} -o ${pickle_si}
    
    # plot results
    python figure_2.py -t pdf -p ../data_out/${bb}/${bb} -n ${nsets} -i ../data_out/${bb}/results_nsets${nsets}.nc -o nc
    pdfcrop ../data_out/${bb}/${bb}.pdf
    mv ../data_out/${bb}/${bb}-crop.pdf ../data_out/${bb}/${bb}.pdf
    
fi

# 1000 sets, package 1, 139 basins
# job ID: 30682750

# 1000 sets, package 2, 139 basins
# job ID: 30721123

# 1000 sets, package 3, 139 basins
# job ID: 30767453

# 1000 sets, package 4, 139 basins
# job ID: 30810127

# 1000 sets, package 5, 139 basins
# job ID: 30849755

# 1000 sets, package 6, 134 basins
# job ID: 30901350
